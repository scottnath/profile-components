{
  "type_of": "article",
  "id": 1466138,
  "title": "Bugfix: Multiple Vite Storybooks from Same node_modules",
  "description": "tl;dr   Encountering Failed to fetch dynamically imported module or ENOTEMPTY: directory not...",
  "readable_publish_date": "May 12 2023",
  "slug": "bugfix-multiple-vite-storybooks-from-same-nodemodules-4mg1",
  "path": "/scottnath/bugfix-multiple-vite-storybooks-from-same-nodemodules-4mg1",
  "url": "https://dev.to/scottnath/bugfix-multiple-vite-storybooks-from-same-nodemodules-4mg1",
  "comments_count": 0,
  "public_reactions_count": 0,
  "collection_id": null,
  "published_timestamp": "2023-05-12T17:02:05Z",
  "positive_reactions_count": 0,
  "cover_image": "https://media.dev.to/cdn-cgi/image/width=1000,height=420,fit=cover,gravity=auto,format=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fk026dc27vi3hv6n0apyp.png",
  "social_image": "https://media.dev.to/cdn-cgi/image/width=1000,height=500,fit=cover,gravity=auto,format=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fk026dc27vi3hv6n0apyp.png",
  "canonical_url": "https://scottnath.com/blahg/bug-multiple-vite-storybooks/",
  "created_at": "2023-05-12T17:02:05Z",
  "edited_at": null,
  "crossposted_at": null,
  "published_at": "2023-05-12T17:02:05Z",
  "last_comment_at": "2023-05-12T17:02:05Z",
  "reading_time_minutes": 2,
  "tag_list": "vite, storybook, node, bugfix",
  "tags": [
    "vite",
    "storybook",
    "node",
    "bugfix"
  ],
  "body_html": "<h2>\n  <a name=\"tldr\" href=\"#tldr\">\n  </a>\n  tl;dr\n</h2>\n\n<p>Encountering <code>Failed to fetch dynamically imported module</code> or <code>ENOTEMPTY: directory not empty</code> errors that reference <code>.vite-storybook</code> while running multiple Vite-builder Storybooks in a single package?</p>\n\n<p>In <code>.storybook/main.[js/ts/tsx]</code>, add:<br>\n</p>\n\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight javascript\"><code>  <span class=\"k\">async</span> <span class=\"nx\">viteFinal</span><span class=\"p\">(</span><span class=\"nx\">config</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nx\">config</span><span class=\"p\">.</span><span class=\"nx\">cacheDir</span> <span class=\"o\">=</span> <span class=\"nx\">path</span><span class=\"p\">.</span><span class=\"nx\">join</span><span class=\"p\">(</span><span class=\"nx\">__dirname</span><span class=\"p\">,</span> <span class=\"dl\">'</span><span class=\"s1\">../node_modules/.vite-unique-name</span><span class=\"dl\">'</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"nx\">config</span><span class=\"p\">;</span>\n  <span class=\"p\">},</span>\n</code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode</title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Don't forget to add <code>import path from 'path';</code> to the top of the file.</p>\n\n<h2>\n  <a name=\"what-is-this-bug\" href=\"#what-is-this-bug\">\n  </a>\n  What is this bug?\n</h2>\n\n<p>When running multiple Vite-builder Storybooks in the same repository or package, and each Storybook is built from the same set of <code>node_modules</code>, you may see errors like this:</p>\n\n<p><code>Failed to fetch dynamically imported module: http://localhost:6001/node_modules/.cache/.vite-storybook/deps/@storybook_preact_preview.js?v=a6ee60c2</code></p>\n\n<p>or</p>\n\n<p><code>Error: ENOTEMPTY: directory not empty, rename '/Users/.../node_modules/.cache/.vite-storybook/deps_temp...' -&gt; '/Users/.../node_modules/.cache/.vite-storybook/deps'</code></p>\n\n<p>or</p>\n\n<p><code>ENOENT: no such file or directory, realpath '/Users/.../node_modules/.cache/vite-plugin-externals/@storybook/preview-api.js' [plugin vite:dep-pre-bundle]</code></p>\n\n<h2>\n  <a name=\"why-is-this-bug\" href=\"#why-is-this-bug\">\n  </a>\n  Why is this bug?\n</h2>\n\n<p>That's a lot of different errors! And while they maybe be caused by a different problem, I have seen them all be caused by a multi-Storybook environment where all Storybooks use Vite builder.</p>\n\n<p>So assuming your error is a bug caused by the Vite-bundler used by Storybook - it's because Vite's setup is not expecting there to be more than one Storybook instance in a repo.</p>\n\n<p>Vite uses a cache directory to store the compiled code required to run Storybook. When multiple Storybooks are built from the same set of <code>node_modules</code>, the cache directory is shared between them. This causes the error above and will allow only one instance of Storybook to run at a time.</p>\n\n<h2>\n  <a name=\"how-to-fix-this-bug\" href=\"#how-to-fix-this-bug\">\n  </a>\n  How to fix this bug\n</h2>\n\n<p>The default cache directory is <code>&lt;package-root&gt;/node_modules/.cache/.vite-storybook</code>. You can change this by setting Vite's <code>cacheDir</code> option in your Storybook's <code>.storybook/main.[js/ts/tsx]</code> file:<br>\n</p>\n\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight javascript\"><code>  <span class=\"k\">import</span> <span class=\"nx\">path</span> <span class=\"k\">from</span> <span class=\"dl\">'</span><span class=\"s1\">path</span><span class=\"dl\">'</span><span class=\"p\">;</span>\n  <span class=\"p\">...</span> <span class=\"c1\">// rest of main Storybook config</span>\n  <span class=\"k\">async</span> <span class=\"nx\">viteFinal</span><span class=\"p\">(</span><span class=\"nx\">config</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// Ensures that the cache directory is unique</span>\n    <span class=\"nx\">config</span><span class=\"p\">.</span><span class=\"nx\">cacheDir</span> <span class=\"o\">=</span> <span class=\"nx\">path</span><span class=\"p\">.</span><span class=\"nx\">join</span><span class=\"p\">(</span><span class=\"nx\">__dirname</span><span class=\"p\">,</span> <span class=\"dl\">'</span><span class=\"s1\">../node_modules/.vite-unique-name</span><span class=\"dl\">'</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"nx\">config</span><span class=\"p\">;</span>\n  <span class=\"p\">},</span>\n</code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode</title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>See <a href=\"https://storybook.js.org/docs/react/builders/vite#configuration\">Storybook's Vite builder configuration docs</a> for more in-depth understanding of how to configure Vite for Storybook.</p>\n\n<h2>\n  <a name=\"impact-of-the-fix\" href=\"#impact-of-the-fix\">\n  </a>\n  Impact of the Fix\n</h2>\n\n<p>This fix gives each Storybook instance a unique cache directory. </p>\n\n<p>before:<br>\n</p>\n\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight plaintext\"><code>node_modules\n├── .cache\n│   └── sb-manager\n│   └── storybook\n│   └── vite-plugin-externals\n│   └── .vite-storybook\n│       ├── deps\n</code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode</title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>after:<br>\n</p>\n\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight plaintext\"><code>node_modules\n├── .cache\n│   └── sb-manager\n│   └── storybook\n│   └── vite-plugin-externals\n├── .vite-unique-name\n│   ├── deps\n</code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode</title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<h2>\n  <a name=\"conclusion\" href=\"#conclusion\">\n  </a>\n  Conclusion\n</h2>\n\n<p>I hope this helps you fix your Storybooks! The bugs listed above could definitely be caused by something else, but this idea is def worth a copy-paste-reload attempt 😉.</p>\n\n",
  "body_markdown": "## tl;dr\n\nEncountering `Failed to fetch dynamically imported module` or `ENOTEMPTY: directory not empty` errors that reference `.vite-storybook` while running multiple Vite-builder Storybooks in a single package?\n\nIn `.storybook/main.[js/ts/tsx]`, add:\n\n```js\n  async viteFinal(config) {\n    config.cacheDir = path.join(__dirname, '../node_modules/.vite-unique-name')\n    return config;\n  },\n```\n\nDon't forget to add `import path from 'path';` to the top of the file.\n\n\n## What is this bug?\n\nWhen running multiple Vite-builder Storybooks in the same repository or package, and each Storybook is built from the same set of `node_modules`, you may see errors like this:\n\n`Failed to fetch dynamically imported module: http://localhost:6001/node_modules/.cache/.vite-storybook/deps/@storybook_preact_preview.js?v=a6ee60c2`\n\nor\n\n`Error: ENOTEMPTY: directory not empty, rename '/Users/.../node_modules/.cache/.vite-storybook/deps_temp...' -> '/Users/.../node_modules/.cache/.vite-storybook/deps'`\n\nor\n\n`ENOENT: no such file or directory, realpath '/Users/.../node_modules/.cache/vite-plugin-externals/@storybook/preview-api.js' [plugin vite:dep-pre-bundle]`\n\n## Why is this bug?\n\nThat's a lot of different errors! And while they maybe be caused by a different problem, I have seen them all be caused by a multi-Storybook environment where all Storybooks use Vite builder.\n\nSo assuming your error is a bug caused by the Vite-bundler used by Storybook - it's because Vite's setup is not expecting there to be more than one Storybook instance in a repo.\n\nVite uses a cache directory to store the compiled code required to run Storybook. When multiple Storybooks are built from the same set of `node_modules`, the cache directory is shared between them. This causes the error above and will allow only one instance of Storybook to run at a time.\n\n## How to fix this bug\n\nThe default cache directory is `<package-root>/node_modules/.cache/.vite-storybook`. You can change this by setting Vite's `cacheDir` option in your Storybook's `.storybook/main.[js/ts/tsx]` file:\n\n```js\n  import path from 'path';\n  ... // rest of main Storybook config\n  async viteFinal(config) {\n    // Ensures that the cache directory is unique\n    config.cacheDir = path.join(__dirname, '../node_modules/.vite-unique-name')\n    return config;\n  },\n```\n\nSee [Storybook's Vite builder configuration docs](https://storybook.js.org/docs/react/builders/vite#configuration) for more in-depth understanding of how to configure Vite for Storybook.\n\n## Impact of the Fix\n\nThis fix gives each Storybook instance a unique cache directory. \n\nbefore:\n\n```\nnode_modules\n├── .cache\n│   └── sb-manager\n│   └── storybook\n│   └── vite-plugin-externals\n│   └── .vite-storybook\n│       ├── deps\n```\n\nafter:\n\n```\nnode_modules\n├── .cache\n│   └── sb-manager\n│   └── storybook\n│   └── vite-plugin-externals\n├── .vite-unique-name\n│   ├── deps\n```\n\n## Conclusion\n\nI hope this helps you fix your Storybooks! The bugs listed above could definitely be caused by something else, but this idea is def worth a copy-paste-reload attempt 😉.",
  "user": {
    "name": "Scott Nath",
    "username": "scottnath",
    "twitter_username": null,
    "github_username": "scottnath",
    "user_id": 1055555,
    "website_url": "https://scottnath.com",
    "profile_image": "https://media.dev.to/cdn-cgi/image/width=640,height=640,fit=cover,gravity=auto,format=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Fuser%2Fprofile_image%2F1055555%2F4d0bf90a-bec7-4228-b1ca-d663fa40adeb.jpeg",
    "profile_image_90": "https://media.dev.to/cdn-cgi/image/width=90,height=90,fit=cover,gravity=auto,format=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Fuser%2Fprofile_image%2F1055555%2F4d0bf90a-bec7-4228-b1ca-d663fa40adeb.jpeg"
  }
}
